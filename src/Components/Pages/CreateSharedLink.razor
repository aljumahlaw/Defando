@page "/documents/{documentId:int}/share"
@attribute [Authorize]
@inject ISharedLinkService SharedLinkService
@inject IDocumentService DocumentService
@inject IAuthService AuthService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>إنشاء رابط مشاركة</PageTitle>

<style>
    .share-link-card {
        max-width: 700px;
        margin: 0 auto;
    }

    .generated-link {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        word-break: break-all;
        font-family: monospace;
    }

    .copy-button {
        cursor: pointer;
        transition: all 0.2s;
    }

    .copy-button:hover {
        transform: scale(1.1);
    }
</style>

<div class="container-fluid" dir="rtl">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="bi bi-link-45deg me-2"></i>إنشاء رابط مشاركة
                </h2>
                <button class="btn btn-secondary" @onclick="@(() => Navigation.NavigateTo($"/documents/{DocumentId}"))">
                    <i class="bi bi-arrow-right me-2"></i>العودة للمستند
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <p class="mt-2 text-muted">جاري تحميل بيانات المستند...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        </div>
    }
    else if (document == null)
    {
        <div class="alert alert-warning" role="alert">
            المستند غير موجود
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="card share-link-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>@document.DocumentName
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (createdLink == null)
                        {
                            <!-- Create Link Form -->
                            <EditForm Model="@linkModel" OnValidSubmit="@HandleCreateLink">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="alert alert-danger" role="alert" />

                                <!-- Expiration Date -->
                                <div class="mb-3">
                                    <label for="expiresAt" class="form-label fw-bold">
                                        <i class="bi bi-calendar-x me-1"></i>تاريخ انتهاء الصلاحية <span class="text-danger">*</span>
                                    </label>
                                    <InputDate 
                                        id="expiresAt"
                                        class="form-control" 
                                        @bind-Value="linkModel.ExpiresAt" 
                                        min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")"
                                        aria-label="تاريخ انتهاء الصلاحية"
                                        aria-required="true" />
                                    <ValidationMessage For="@(() => linkModel.ExpiresAt)" />
                                    <small class="form-text text-muted">
                                        اختر تاريخ انتهاء صلاحية الرابط (الحد الأدنى: غداً)
                                    </small>
                                </div>

                                <!-- Max Access Count -->
                                <div class="mb-3">
                                    <label for="maxAccessCount" class="form-label fw-bold">
                                        <i class="bi bi-eye me-1"></i>الحد الأقصى لعدد مرات الوصول
                                    </label>
                                    <InputNumber 
                                        id="maxAccessCount"
                                        class="form-control" 
                                        @bind-Value="linkModel.MaxAccessCount" 
                                        placeholder="اتركه فارغاً لغير محدود"
                                        aria-label="الحد الأقصى لعدد مرات الوصول" />
                                    <small class="form-text text-muted">
                                        اتركه فارغاً للسماح بعدد غير محدود من مرات الوصول
                                    </small>
                                </div>

                                <!-- Password Protection -->
                                <div class="mb-3">
                                    <div class="form-check form-switch mb-2">
                                        <input 
                                            class="form-check-input" 
                                            type="checkbox" 
                                            id="usePassword"
                                            @bind="usePassword"
                                            role="switch" />
                                        <label class="form-check-label" for="usePassword">
                                            <strong>حماية الرابط بكلمة مرور</strong>
                                        </label>
                                    </div>
                                    @if (usePassword)
                                    {
                                        <div>
                                            <label for="password" class="form-label">كلمة المرور</label>
                                            <InputText 
                                                id="password"
                                                type="password"
                                                class="form-control" 
                                                @bind-Value="linkModel.Password" 
                                                placeholder="أدخل كلمة مرور قوية"
                                                aria-label="كلمة مرور الرابط" />
                                            <ValidationMessage For="@(() => linkModel.Password)" />
                                            <small class="form-text text-muted">
                                                سيحتاج المستخدمون إلى إدخال هذه الكلمة للوصول إلى المستند
                                            </small>
                                        </div>
                                    }
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex gap-2 mt-4">
                                    <button 
                                        type="submit" 
                                        class="btn btn-primary flex-grow-1" 
                                        disabled="@isCreating"
                                        aria-label="إنشاء رابط المشاركة">
                                        @if (isCreating)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-link-45deg me-2"></i>
                                        }
                                        إنشاء رابط المشاركة
                                    </button>
                                    <button 
                                        type="button" 
                                        class="btn btn-outline-secondary" 
                                        @onclick="@(() => Navigation.NavigateTo($"/documents/{DocumentId}"))"
                                        aria-label="إلغاء">
                                        إلغاء
                                    </button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <!-- Generated Link Display -->
                            <div class="text-center">
                                <div class="mb-4">
                                    <i class="bi bi-check-circle-fill text-success fs-1 d-block mb-3"></i>
                                    <h4 class="text-success">تم إنشاء رابط المشاركة بنجاح!</h4>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">رابط المشاركة:</label>
                                    <div class="generated-link d-flex align-items-center gap-2">
                                        <span class="flex-grow-1" id="linkText">@fullLink</span>
                                        <button 
                                            class="btn btn-sm btn-outline-primary copy-button" 
                                            @onclick="@(() => CopyToClipboard())"
                                            title="نسخ الرابط"
                                            aria-label="نسخ الرابط">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="bi bi-info-circle me-2"></i>معلومات الرابط:
                                    </h6>
                                    <ul class="mb-0 text-start">
                                        <li><strong>تاريخ الانتهاء:</strong> @createdLink.ExpiresAt.ToString("yyyy-MM-dd HH:mm")</li>
                                        @if (createdLink.MaxAccessCount.HasValue)
                                        {
                                            <li><strong>الحد الأقصى للوصول:</strong> @createdLink.MaxAccessCount.Value مرة</li>
                                        }
                                        else
                                        {
                                            <li><strong>الحد الأقصى للوصول:</strong> غير محدود</li>
                                        }
                                        <li><strong>عدد مرات الوصول الحالية:</strong> @createdLink.CurrentAccessCount</li>
                                        @if (!string.IsNullOrEmpty(linkModel.Password))
                                        {
                                            <li><strong>الحماية:</strong> محمي بكلمة مرور</li>
                                        }
                                    </ul>
                                </div>

                                <div class="d-flex gap-2 justify-content-center mt-4">
                                    <button 
                                        class="btn btn-primary" 
                                        @onclick="@(() => CopyToClipboard())"
                                        aria-label="نسخ الرابط">
                                        <i class="bi bi-clipboard me-2"></i>نسخ الرابط
                                    </button>
                                    <button 
                                        class="btn btn-outline-secondary" 
                                        @onclick="@(() => CreateNewLink())"
                                        aria-label="إنشاء رابط جديد">
                                        <i class="bi bi-plus-circle me-2"></i>إنشاء رابط جديد
                                    </button>
                                    <button 
                                        class="btn btn-outline-secondary" 
                                        @onclick="@(() => Navigation.NavigateTo($"/documents/{DocumentId}"))"
                                        aria-label="العودة للمستند">
                                        <i class="bi bi-arrow-right me-2"></i>العودة
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int DocumentId { get; set; }

    private Document? document;
    private SharedLink? createdLink;
    private bool isLoading = true;
    private bool isCreating = false;
    private bool usePassword = false;
    private string? errorMessage;
    private string? fullLink;

    private CreateLinkModel linkModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDocument();
    }

    private async Task LoadDocument()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            document = await DocumentService.GetDocumentByIdAsync(DocumentId);
            if (document == null)
            {
                errorMessage = "المستند غير موجود";
            }
            else
            {
                // Set default expiration to 7 days from now
                linkModel.ExpiresAt = DateTime.Now.AddDays(7);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل المستند: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleCreateLink()
    {
        isCreating = true;
        errorMessage = null;

        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                errorMessage = "يجب تسجيل الدخول أولاً.";
                isCreating = false;
                return;
            }

            createdLink = await SharedLinkService.CreateSharedLinkAsync(
                documentId: DocumentId,
                createdBy: currentUser.UserId,
                expiresAt: linkModel.ExpiresAt,
                maxAccessCount: linkModel.MaxAccessCount,
                password: usePassword ? linkModel.Password : null
            );

            // Generate full link URL
            var baseUrl = Navigation.BaseUri.TrimEnd('/');
            fullLink = $"{baseUrl}/shared/{createdLink.LinkToken}";

            // Show success notification
            NotificationService.ShowSuccess("تم إنشاء رابط المشاركة بنجاح!");
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء إنشاء رابط المشاركة: {ex.Message}";
            NotificationService.ShowError($"فشل إنشاء رابط المشاركة: {ex.Message}");
        }
        finally
        {
            isCreating = false;
        }
    }

    private async Task CopyToClipboard()
    {
        if (!string.IsNullOrEmpty(fullLink))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", fullLink);
            // Show toast notification (you can enhance this)
        }
    }

    private void CreateNewLink()
    {
        createdLink = null;
        linkModel = new CreateLinkModel
        {
            ExpiresAt = DateTime.Now.AddDays(7)
        };
        usePassword = false;
        fullLink = null;
    }

    private class CreateLinkModel
    {
        [Required(ErrorMessage = "تاريخ انتهاء الصلاحية مطلوب")]
        public DateTime ExpiresAt { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "يجب أن يكون الحد الأقصى أكبر من 0")]
        public int? MaxAccessCount { get; set; }

        [MinLength(4, ErrorMessage = "كلمة المرور يجب أن تكون 4 أحرف على الأقل")]
        public string? Password { get; set; }
    }
}

