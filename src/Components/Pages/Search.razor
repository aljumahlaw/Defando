@page "/search"
@attribute [Authorize]
@inject IDocumentService DocumentService
@inject IFolderService FolderService
@inject NavigationManager Navigation

<PageTitle>البحث في المستندات</PageTitle>

<style>
    mark {
        background-color: #ffc107;
        color: #000;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }

    .search-result-item {
        transition: background-color 0.2s ease;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .pagination .page-link {
        color: #0d6efd;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    @@media (max-width: 768px) {
        .col-md-3 {
            margin-bottom: 1rem;
        }
    }
</style>

<div class="container-fluid" dir="rtl">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-search me-2"></i>البحث في المستندات
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- Search Filters Sidebar -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>الفلاتر
                    </h5>
                </div>
                <div class="card-body">
                    <form @onsubmit="HandleSearch" @onsubmit:preventDefault="true">
                        <!-- Search Query -->
                        <div class="mb-3">
                            <label for="searchQuery" class="form-label fw-bold">
                                <i class="bi bi-search me-1"></i>كلمة البحث
                            </label>
                            <input 
                                type="text" 
                                id="searchQuery"
                                class="form-control" 
                                @bind="searchQuery" 
                                @bind:event="oninput"
                                placeholder="أدخل كلمة البحث..."
                                aria-label="كلمة البحث"
                                autocomplete="off" />
                            <small class="form-text text-muted">
                                يمكنك البحث في اسم المستند، النوع، أو المحتوى
                            </small>
                        </div>

                        <!-- Folder Filter -->
                        <div class="mb-3">
                            <label for="folderFilter" class="form-label fw-bold">
                                <i class="bi bi-folder me-1"></i>المجلد
                            </label>
                            <select 
                                id="folderFilter"
                                class="form-select" 
                                @bind="selectedFolderId"
                                aria-label="اختر المجلد">
                                <option value="">جميع المجلدات</option>
                                @foreach (var folder in folders)
                                {
                                    <option value="@folder.FolderId">@folder.FolderName</option>
                                }
                            </select>
                        </div>

                        <!-- Document Type Filter -->
                        <div class="mb-3">
                            <label for="typeFilter" class="form-label fw-bold">
                                <i class="bi bi-file-earmark me-1"></i>نوع المستند
                            </label>
                            <select 
                                id="typeFilter"
                                class="form-select" 
                                @bind="selectedDocumentType"
                                aria-label="اختر نوع المستند">
                                <option value="">جميع الأنواع</option>
                                <option value="pdf">PDF</option>
                                <option value="docx">Word</option>
                                <option value="jpg">صورة</option>
                                <option value="png">صورة</option>
                            </select>
                        </div>

                        <!-- Date Range -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar me-1"></i>نطاق التاريخ
                            </label>
                            <div class="mb-2">
                                <label for="startDate" class="form-label small">من:</label>
                                <input 
                                    type="date" 
                                    id="startDate"
                                    class="form-control form-control-sm" 
                                    @bind="startDate"
                                    aria-label="تاريخ البداية" />
                            </div>
                            <div>
                                <label for="endDate" class="form-label small">إلى:</label>
                                <input 
                                    type="date" 
                                    id="endDate"
                                    class="form-control form-control-sm" 
                                    @bind="endDate"
                                    aria-label="تاريخ النهاية" />
                            </div>
                        </div>

                        <!-- Sort By -->
                        <div class="mb-3">
                            <label for="sortBy" class="form-label fw-bold">
                                <i class="bi bi-sort-alpha-down me-1"></i>ترتيب حسب
                            </label>
                            <select 
                                id="sortBy"
                                class="form-select" 
                                @bind="sortBy"
                                aria-label="ترتيب النتائج">
                                <option value="relevance">الصلة (الأكثر صلة)</option>
                                <option value="date_desc">الأحدث أولاً</option>
                                <option value="date_asc">الأقدم أولاً</option>
                                <option value="size_desc">الأكبر حجماً</option>
                                <option value="size_asc">الأصغر حجماً</option>
                            </select>
                        </div>

                        <!-- Search Button -->
                        <button 
                            type="submit" 
                            class="btn btn-primary w-100 mb-2" 
                            disabled="@isSearching"
                            aria-label="بحث">
                            @if (isSearching)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            else
                            {
                                <i class="bi bi-search me-2"></i>
                            }
                            بحث
                        </button>

                        <!-- Clear Filters -->
                        <button 
                            type="button" 
                            class="btn btn-outline-secondary w-100" 
                            @onclick="ClearFilters"
                            aria-label="مسح الفلاتر">
                            <i class="bi bi-x-circle me-2"></i>مسح الفلاتر
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="col-md-9">
            @if (isSearching && !hasSearched)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري البحث...</span>
                    </div>
                    <p class="mt-2 text-muted">جاري البحث في المستندات...</p>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="إغلاق"></button>
                </div>
            }
            else if (hasSearched)
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>نتائج البحث
                        </h5>
                        <span class="badge bg-info fs-6">
                            @(searchResult?.TotalCount ?? 0) نتيجة
                        </span>
                    </div>
                    <div class="card-body">
                        @if (searchResult != null && searchResult.Results.Any())
                        {
                            <!-- Results List -->
                            <div class="list-group" role="list">
                                @foreach (var result in searchResult.Results)
                                {
                                    <div class="list-group-item search-result-item" role="listitem">
                                        <div class="d-flex w-100 justify-content-between mb-2 flex-wrap">
                                            <h6 class="mb-1 flex-grow-1">
                                                <a href="/documents/@result.Document.DocumentId" class="text-decoration-none fw-bold" aria-label="عرض تفاصيل المستند @result.Document.DocumentName">
                                                    @((MarkupString)result.HighlightedName)
                                                </a>
                                            </h6>
                                            <div class="d-flex gap-2 align-items-center">
                                                @if (!string.IsNullOrEmpty(result.Document.DocumentType))
                                                {
                                                    <span class="badge bg-secondary">@result.Document.DocumentType</span>
                                                }
                                                @if (result.Rank > 0 && sortBy == "relevance")
                                                {
                                                    <span class="badge bg-info" title="مستوى الصلة بالبحث">
                                                        <i class="bi bi-star-fill me-1"></i>@result.Rank.ToString("F2")
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            @if (!string.IsNullOrEmpty(result.HighlightedType))
                                            {
                                                <span class="text-muted small">
                                                    النوع: @((MarkupString)result.HighlightedType)
                                                </span>
                                            }
                                            @if (result.Document.Folder != null)
                                            {
                                                <span class="text-muted small ms-2">
                                                    <i class="bi bi-folder me-1"></i>@result.Document.Folder.FolderName
                                                </span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(result.Snippet))
                                        {
                                            <p class="mb-1 small text-muted">
                                                @((MarkupString)result.Snippet)
                                            </p>
                                        }
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar me-1"></i>
                                                @result.Document.UploadedAt.ToString("yyyy-MM-dd")
                                                <span class="ms-2">
                                                    <i class="bi bi-person me-1"></i>
                                                    @(result.Document.UploadedByUser?.FullName ?? "غير معروف")
                                                </span>
                                                @if (result.Document.FileSize.HasValue)
                                                {
                                                    <span class="ms-2">
                                                        <i class="bi bi-file-earmark me-1"></i>
                                                        @FormatFileSize(result.Document.FileSize.Value)
                                                    </span>
                                                }
                                            </small>
                                            <div>
                                                <a href="/documents/@result.Document.DocumentId" class="btn btn-sm btn-outline-primary" aria-label="عرض تفاصيل المستند">
                                                    <i class="bi bi-eye me-1"></i><span class="d-none d-md-inline">عرض</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Pagination -->
                            @if (searchResult.TotalPages > 1)
                            {
                                <nav aria-label="صفحات النتائج" class="mt-4">
                                    <ul class="pagination justify-content-center flex-wrap">
                                        <li class="page-item @(!searchResult.HasPreviousPage ? "disabled" : "")">
                                            <button 
                                                class="page-link" 
                                                @onclick="() => GoToPage(searchResult.CurrentPage - 1)" 
                                                disabled="@(!searchResult.HasPreviousPage || isSearching)"
                                                aria-label="الصفحة السابقة">
                                                <span aria-hidden="true">&laquo;</span>
                                                <span class="visually-hidden">السابق</span>
                                            </button>
                                        </li>
                                        @if (searchResult.CurrentPage > 3)
                                        {
                                            <li class="page-item">
                                                <button class="page-link" @onclick="() => GoToPage(1)" disabled="@isSearching">1</button>
                                            </li>
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        }
                                        @for (int i = Math.Max(1, searchResult.CurrentPage - 2); 
                                             i <= Math.Min(searchResult.TotalPages, searchResult.CurrentPage + 2); 
                                             i++)
                                        {
                                            var pageNum = i;
                                            <li class="page-item @(pageNum == searchResult.CurrentPage ? "active" : "")">
                                                <button 
                                                    class="page-link" 
                                                    @onclick="() => GoToPage(pageNum)" 
                                                    disabled="@isSearching"
                                                    aria-label="الصفحة @pageNum"
                                                    aria-current="@(pageNum == searchResult.CurrentPage ? "page" : null)">
                                                    @pageNum
                                                </button>
                                            </li>
                                        }
                                        @if (searchResult.CurrentPage < searchResult.TotalPages - 2)
                                        {
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                            <li class="page-item">
                                                <button class="page-link" @onclick="() => GoToPage(searchResult.TotalPages)" disabled="@isSearching">
                                                    @searchResult.TotalPages
                                                </button>
                                            </li>
                                        }
                                        <li class="page-item @(!searchResult.HasNextPage ? "disabled" : "")">
                                            <button 
                                                class="page-link" 
                                                @onclick="() => GoToPage(searchResult.CurrentPage + 1)" 
                                                disabled="@(!searchResult.HasNextPage || isSearching)"
                                                aria-label="الصفحة التالية">
                                                <span aria-hidden="true">&raquo;</span>
                                                <span class="visually-hidden">التالي</span>
                                            </button>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-center text-muted small mt-2" role="status" aria-live="polite">
                                    عرض @((searchResult.CurrentPage - 1) * searchResult.PageSize + 1) - @(Math.Min(searchResult.CurrentPage * searchResult.PageSize, searchResult.TotalCount)) من @searchResult.TotalCount نتيجة
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                <p class="text-muted">لم يتم العثور على نتائج</p>
                                <p class="small text-muted">جرب تغيير كلمات البحث أو الفلاتر</p>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-search fs-1 d-block mb-3 text-muted"></i>
                        <p class="text-muted">ابدأ البحث عن المستندات</p>
                        <p class="small text-muted">استخدم الفلاتر على اليسار للبحث المتقدم</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string searchQuery = string.Empty;
    private int? selectedFolderId;
    private string? selectedDocumentType;
    private DateTime? startDate;
    private DateTime? endDate;
    private string sortBy = "relevance";
    private PaginatedSearchResult? searchResult;
    private List<Folder> folders = new();
    private bool isSearching = false;
    private bool hasSearched = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadFolders();
    }

    private async Task LoadFolders()
    {
        try
        {
            folders = await FolderService.GetAllFoldersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل المجلدات: {ex.Message}";
        }
    }

    private async Task HandleSearch()
    {
        await PerformSearch();
    }

    private async Task PerformSearch()
    {
        isSearching = true;
        errorMessage = null;
        hasSearched = true;

        try
        {
            searchResult = await DocumentService.AdvancedSearchAsync(
                query: searchQuery,
                folderId: selectedFolderId,
                documentType: selectedDocumentType,
                startDate: startDate,
                endDate: endDate,
                page: searchResult?.CurrentPage ?? 1,
                pageSize: 10,
                sortBy: sortBy
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء البحث: {ex.Message}";
            searchResult = null;
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task GoToPage(int page)
    {
        if (searchResult == null || page < 1 || page > searchResult.TotalPages || isSearching)
            return;

        isSearching = true;
        errorMessage = null;

        try
        {
            searchResult = await DocumentService.AdvancedSearchAsync(
                query: searchQuery,
                folderId: selectedFolderId,
                documentType: selectedDocumentType,
                startDate: startDate,
                endDate: endDate,
                page: page,
                pageSize: 10,
                sortBy: sortBy
            );
        }
        catch (Exception ex)
        {
            errorMessage = $"حدث خطأ أثناء تحميل الصفحة: {ex.Message}";
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task ClearFilters()
    {
        searchQuery = string.Empty;
        selectedFolderId = null;
        selectedDocumentType = null;
        startDate = null;
        endDate = null;
        sortBy = "relevance";
        searchResult = null;
        hasSearched = false;
        errorMessage = null;
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes == 0)
            return "0 B";

        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double size = bytes;

        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }

        return $"{size:0.##} {sizes[order]}";
    }
}

