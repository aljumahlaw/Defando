@page "/outgoing"
@using Defando.Models
@attribute [Authorize]
@using Defando.Extensions
@inject IOutgoingService OutgoingService
@inject IDocumentService DocumentService
@inject IAuthService AuthService
@inject INotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>إدارة الصادر</PageTitle>

<div class="container-fluid" dir="rtl">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-send me-2"></i>إدارة المراسلات الصادرة</h2>
        @if (canCreate)
        {
            <button class="btn btn-primary" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle me-2"></i>إضافة صادر جديد
            </button>
        }
    </div>

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filterStartDate" class="form-label">من تاريخ</label>
                    <InputDate id="filterStartDate" class="form-control" @bind-Value="filterStartDate" />
                </div>
                <div class="col-md-3">
                    <label for="filterEndDate" class="form-label">إلى تاريخ</label>
                    <InputDate id="filterEndDate" class="form-control" @bind-Value="filterEndDate" />
                </div>
                <div class="col-md-3">
                    <label for="filterRecipient" class="form-label">الجهة المرسل إليها</label>
                    <InputText id="filterRecipient" class="form-control" @bind-Value="filterRecipient" placeholder="ابحث عن جهة..." />
                </div>
                <div class="col-md-3">
                    <label for="filterDeliveryMethod" class="form-label">طريقة التسليم</label>
                    <InputText id="filterDeliveryMethod" class="form-control" @bind-Value="filterDeliveryMethod" placeholder="مثال: بريد، إيميل..." />
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary me-2" @onclick="ApplyFilters">
                        <i class="bi bi-funnel me-2"></i>تطبيق الفلاتر
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearFilters">
                        <i class="bi bi-x-circle me-2"></i>مسح الفلاتر
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <p class="mt-2 text-muted">جاري تحميل البيانات...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>رقم الصادر</th>
                                <th>التاريخ</th>
                                <th>الجهة المرسل إليها</th>
                                <th>الموضوع</th>
                                <th>طريقة التسليم</th>
                                <th>المستند المرتبط</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (outgoingList == null || !outgoingList.Any())
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        لا توجد مراسلات صادرة
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var outgoing in outgoingList)
                                {
                                    <tr>
                                        <td><strong>@outgoing.OutgoingNumber</strong></td>
                                        <td>@outgoing.SendDate.ToString("yyyy-MM-dd")</td>
                                        <td>@outgoing.RecipientName</td>
                                        <td>@outgoing.Subject</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(outgoing.DeliveryMethod))
                                            {
                                                <span class="badge bg-info">@outgoing.DeliveryMethod</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (outgoing.Document != null)
                                            {
                                                <a href="/documents/@outgoing.Document.DocumentId" class="text-decoration-none">
                                                    <i class="bi bi-file-earmark-text me-1"></i>@outgoing.Document.DocumentName
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-info" @onclick="() => ShowDetailsModal(outgoing.OutgoingId)" title="عرض التفاصيل">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                @if (canEdit)
                                                {
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowEditModal(outgoing.OutgoingId)" title="تعديل">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                }
                                                @if (canDelete)
                                                {
                                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(outgoing.OutgoingId)" title="حذف">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Add/Edit Modal -->
    @if (showModal)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            @(isEditMode ? "تعديل صادر" : "إضافة صادر جديد")
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@outgoingModel" OnValidSubmit="@HandleSave">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="alert alert-danger" role="alert" />

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="outgoingNumber" class="form-label">رقم الصادر <span class="text-danger">*</span></label>
                                    <InputText id="outgoingNumber" class="form-control" @bind-Value="outgoingModel.OutgoingNumber" />
                                    <ValidationMessage For="@(() => outgoingModel.OutgoingNumber)" />
                                    <small class="form-text text-muted">سيتم توليد الرقم تلقائياً إذا تركت الحقل فارغاً</small>
                                </div>

                                <div class="col-md-6">
                                    <label for="sendDate" class="form-label">تاريخ الإرسال <span class="text-danger">*</span></label>
                                    <InputDate id="sendDate" class="form-control" @bind-Value="outgoingModel.SendDate" />
                                    <ValidationMessage For="@(() => outgoingModel.SendDate)" />
                                </div>

                                <div class="col-md-6">
                                    <label for="recipientName" class="form-label">الجهة المرسل إليها <span class="text-danger">*</span></label>
                                    <InputText id="recipientName" class="form-control" @bind-Value="outgoingModel.RecipientName" />
                                    <ValidationMessage For="@(() => outgoingModel.RecipientName)" />
                                </div>

                                <div class="col-md-6">
                                    <label for="recipientAddress" class="form-label">عنوان الجهة</label>
                                    <InputText id="recipientAddress" class="form-control" @bind-Value="outgoingModel.RecipientAddress" />
                                </div>

                                <div class="col-md-12">
                                    <label for="subject" class="form-label">الموضوع <span class="text-danger">*</span></label>
                                    <InputText id="subject" class="form-control" @bind-Value="outgoingModel.Subject" />
                                    <ValidationMessage For="@(() => outgoingModel.Subject)" />
                                </div>

                                <div class="col-md-6">
                                    <label for="deliveryMethod" class="form-label">طريقة التسليم</label>
                                    <InputText id="deliveryMethod" class="form-control" @bind-Value="outgoingModel.DeliveryMethod" />
                                </div>

                                <div class="col-md-6">
                                    <label for="trackingNumber" class="form-label">رقم التتبع (إن وجد)</label>
                                    <InputText id="trackingNumber" class="form-control" @bind-Value="outgoingModel.TrackingNumber" />
                                </div>

                                <div class="col-md-12">
                                    <label for="documentId" class="form-label">المستند المرتبط (اختياري)</label>
                                    <InputSelect id="documentId" class="form-select" @bind-Value="outgoingModel.DocumentId">
                                        <option value="">اختر مستند...</option>
                                        @if (documents != null)
                                        {
                                            @foreach (var doc in documents)
                                            {
                                                <option value="@doc.DocumentId">@doc.DocumentName (@doc.DocumentId)</option>
                                            }
                                        }
                                    </InputSelect>
                                </div>

                                <div class="col-md-12">
                                    <label for="notes" class="form-label">ملاحظات</label>
                                    <InputTextArea id="notes" class="form-control" @bind-Value="outgoingModel.Notes" rows="3" />
                                </div>
                            </div>

                            <div class="modal-footer mt-4">
                                <button type="button" class="btn btn-secondary" @onclick="CloseModal">إلغاء</button>
                                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>جاري الحفظ...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-save me-2"></i>
                                        <span>حفظ</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Details Modal -->
    @if (showDetailsModal && selectedOutgoing != null)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تفاصيل الصادر رقم: @selectedOutgoing.OutgoingNumber</h5>
                        <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                    </div>
                    <div class="modal-body">
                        <dl class="row">
                            <dt class="col-sm-4">رقم الصادر:</dt>
                            <dd class="col-sm-8">@selectedOutgoing.OutgoingNumber</dd>

                            <dt class="col-sm-4">تاريخ الإرسال:</dt>
                            <dd class="col-sm-8">@selectedOutgoing.SendDate.ToString("yyyy-MM-dd")</dd>

                            <dt class="col-sm-4">الجهة المرسل إليها:</dt>
                            <dd class="col-sm-8">@selectedOutgoing.RecipientName</dd>

                            <dt class="col-sm-4">عنوان الجهة:</dt>
                            <dd class="col-sm-8">@(selectedOutgoing.RecipientAddress ?? "-")</dd>

                            <dt class="col-sm-4">الموضوع:</dt>
                            <dd class="col-sm-8">@selectedOutgoing.Subject</dd>

                            <dt class="col-sm-4">طريقة التسليم:</dt>
                            <dd class="col-sm-8">@(selectedOutgoing.DeliveryMethod ?? "-")</dd>

                            <dt class="col-sm-4">رقم التتبع:</dt>
                            <dd class="col-sm-8">@(selectedOutgoing.TrackingNumber ?? "-")</dd>

                            <dt class="col-sm-4">المستند المرتبط:</dt>
                            <dd class="col-sm-8">
                                @if (selectedOutgoing.Document != null)
                                {
                                    <a href="/documents/@selectedOutgoing.Document.DocumentId" class="text-decoration-none">
                                        <i class="bi bi-file-earmark-text me-1"></i>@selectedOutgoing.Document.DocumentName
                                    </a>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </dd>

                            <dt class="col-sm-4">الملاحظات:</dt>
                            <dd class="col-sm-8">@(selectedOutgoing.Notes ?? "-")</dd>

                            <dt class="col-sm-4">أنشئ بواسطة:</dt>
                            <dd class="col-sm-8">@selectedOutgoing.CreatedBy</dd>
                        </dl>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">إغلاق</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Defando.Models.Outgoing>? outgoingList;
    private List<Defando.Models.Document>? documents;
    private bool isLoading = true;
    private string? errorMessage;
    private bool showModal = false;
    private bool showDetailsModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private OutgoingModel outgoingModel = new OutgoingModel();
    private Defando.Models.Outgoing? selectedOutgoing;

    // Permissions
    private bool canCreate = false;
    private bool canEdit = false;
    private bool canDelete = false;

    // Filters
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private string? filterRecipient;
    private string? filterDeliveryMethod;

    protected override async Task OnInitializedAsync()
    {
        await LoadPermissions();
        await LoadOutgoing();
        await LoadDocuments();
    }

    private async Task LoadPermissions()
    {
        var user = await AuthService.GetCurrentUserAsync();
        if (user != null)
        {
            canCreate = user.HasPermission("Outgoing.Create");
            canEdit = user.HasPermission("Outgoing.Edit");
            canDelete = user.HasPermission("Outgoing.Delete");
        }
    }

    private async Task LoadOutgoing()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            outgoingList = await OutgoingService.GetAllOutgoingAsync();
            ApplyFilters(); // Apply initial filters (which are null/empty)
        }
        catch (Exception ex)
        {
            errorMessage = $"فشل في تحميل المراسلات الصادرة: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDocuments()
    {
        try
        {
            var result = await DocumentService.GetAllDocumentsAsync();
            documents = result.Documents;
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"فشل في تحميل قائمة المستندات: {ex.Message}");
        }
    }

    private void ApplyFilters()
    {
        if (outgoingList == null) return;

        var filteredList = outgoingList.AsEnumerable();

        if (filterStartDate.HasValue)
        {
            filteredList = filteredList.Where(o => o.SendDate.Date >= filterStartDate.Value.Date);
        }

        if (filterEndDate.HasValue)
        {
            filteredList = filteredList.Where(o => o.SendDate.Date <= filterEndDate.Value.Date);
        }

        if (!string.IsNullOrWhiteSpace(filterRecipient))
        {
            filteredList = filteredList.Where(o => o.RecipientName.Contains(filterRecipient, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(filterDeliveryMethod))
        {
            filteredList = filteredList.Where(o => o.DeliveryMethod != null && o.DeliveryMethod.Contains(filterDeliveryMethod, StringComparison.OrdinalIgnoreCase));
        }

        outgoingList = filteredList.ToList();
    }

    private async Task ClearFilters()
    {
        filterStartDate = null;
        filterEndDate = null;
        filterRecipient = null;
        filterDeliveryMethod = null;
        await LoadOutgoing(); // Reload to get the original list
    }

    private void ShowAddModal()
    {
        if (!canCreate)
        {
            NotificationService.ShowError("ليس لديك صلاحية للإضافة");
            return;
        }
        outgoingModel = new OutgoingModel();
        isEditMode = false;
        showModal = true;
    }

    private async Task ShowEditModal(int id)
    {
        if (!canEdit)
        {
            NotificationService.ShowError("ليس لديك صلاحية للتعديل");
            return;
        }
        try
        {
            var outgoing = await OutgoingService.GetOutgoingByIdAsync(id);
            if (outgoing != null)
            {
                outgoingModel = new OutgoingModel
                {
                    OutgoingId = outgoing.OutgoingId,
                    OutgoingNumber = outgoing.OutgoingNumber,
                    SendDate = outgoing.SendDate,
                    RecipientName = outgoing.RecipientName,
                    RecipientAddress = outgoing.RecipientAddress,
                    Subject = outgoing.Subject,
                    DeliveryMethod = outgoing.DeliveryMethod,
                    TrackingNumber = outgoing.TrackingNumber,
                    DocumentId = outgoing.DocumentId,
                    Notes = outgoing.Notes
                };
                isEditMode = true;
                showModal = true;
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"فشل في تحميل بيانات الصادر: {ex.Message}");
        }
    }

    private async Task ShowDetailsModal(int id)
    {
        try
        {
            selectedOutgoing = await OutgoingService.GetOutgoingByIdAsync(id);
            if (selectedOutgoing != null)
            {
                showDetailsModal = true;
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"فشل في تحميل تفاصيل الصادر: {ex.Message}");
        }
    }

    private void CloseModal()
    {
        showModal = false;
        outgoingModel = new OutgoingModel();
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedOutgoing = null;
    }

    private async Task HandleSave()
    {
        isSaving = true;

        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                NotificationService.ShowError("يجب تسجيل الدخول أولاً");
                return;
            }

            var outgoing = new Defando.Models.Outgoing
            {
                OutgoingId = outgoingModel.OutgoingId,
                OutgoingNumber = outgoingModel.OutgoingNumber,
                SendDate = outgoingModel.SendDate,
                RecipientName = outgoingModel.RecipientName,
                RecipientAddress = outgoingModel.RecipientAddress,
                Subject = outgoingModel.Subject,
                DeliveryMethod = outgoingModel.DeliveryMethod,
                TrackingNumber = outgoingModel.TrackingNumber,
                DocumentId = outgoingModel.DocumentId == 0 ? null : outgoingModel.DocumentId,
                Notes = outgoingModel.Notes,
                CreatedBy = currentUser.UserId
            };

            if (isEditMode)
            {
                await OutgoingService.UpdateOutgoingAsync(outgoing);
                NotificationService.ShowSuccess("تم تحديث الصادر بنجاح");
            }
            else
            {
                await OutgoingService.CreateOutgoingAsync(outgoing);
                NotificationService.ShowSuccess("تم إضافة الصادر بنجاح");
            }

            CloseModal();
            await LoadOutgoing();
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"حدث خطأ أثناء الحفظ: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ConfirmDelete(int id)
    {
        if (!canDelete)
        {
            NotificationService.ShowError("ليس لديك صلاحية للحذف");
            return;
        }

        // Simple confirmation - in production, use a proper confirmation dialog
        if (await JSRuntime.InvokeAsync<bool>("confirm", "هل أنت متأكد من حذف هذا السجل؟"))
        {
            try
            {
                await OutgoingService.DeleteOutgoingAsync(id);
                NotificationService.ShowSuccess("تم حذف الصادر بنجاح");
                await LoadOutgoing();
            }
            catch (Exception ex)
            {
                NotificationService.ShowError($"حدث خطأ أثناء الحذف: {ex.Message}");
            }
        }
    }

    private class OutgoingModel
    {
        public int OutgoingId { get; set; }

        [MaxLength(60)]
        public string OutgoingNumber { get; set; } = string.Empty;

        [Required(ErrorMessage = "تاريخ الإرسال مطلوب")]
        public DateTime SendDate { get; set; } = DateTime.Now.Date;

        [Required(ErrorMessage = "الجهة المرسل إليها مطلوبة")]
        [MaxLength(200, ErrorMessage = "الحد الأقصى 200 حرف")]
        public string RecipientName { get; set; } = string.Empty;

        [MaxLength(500)]
        public string? RecipientAddress { get; set; }

        [Required(ErrorMessage = "الموضوع مطلوب")]
        [MaxLength(500, ErrorMessage = "الحد الأقصى 500 حرف")]
        public string Subject { get; set; } = string.Empty;

        [MaxLength(50)]
        public string? DeliveryMethod { get; set; }

        [MaxLength(120)]
        public string? TrackingNumber { get; set; }

        public int? DocumentId { get; set; }

        public string? Notes { get; set; }
    }

    [Inject] private IJSRuntime? JSRuntime { get; set; }
}
